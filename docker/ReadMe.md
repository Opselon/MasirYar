# مدیریت زیرساخت پروژه با Docker Compose

این پوشه شامل تمام فایل‌ها و تنظیمات مربوط به راه‌اندازی و مدیریت **زیرساخت** پروژه با استفاده از `Docker Compose` است. هدف ما این است که هر توسعه‌دهنده‌ای بتواند با یک دستور ساده، تمام نیازمندی‌های پروژه (مانند دیتابیس، کش و...) را به صورت کانتینرهای ایزوله و مستقل راه‌اندازی کند.

## فلسفه "زیرساخت به عنوان کد" (Infrastructure as Code)

ما از رویکرد **Infrastructure as Code (IaC)** استفاده می‌کنیم. این یعنی تمام تنظیمات و پیکربندی‌های زیرساخت، به جای انجام دستی، در یک فایل متنی (`docker-compose.yml`) تعریف شده‌اند.

**مزایای این رویکرد:**
-   **تکرارپذیری:** هر توسعه‌دهنده در تیم، دقیقاً یک محیط یکسان را اجرا می‌کند. این کار مشکلات کلاسیک "روی سیستم من کار می‌کند!" را از بین می‌برد.
-   **نسخه‌بندی:** فایل `docker-compose.yml` مانند هر فایل کد دیگری در Git نسخه‌بندی می‌شود. می‌توانیم تاریخچه تغییرات را ببینیم و در صورت نیاز به نسخه‌های قبلی برگردیم.
-   **اتوماسیون:** راه‌اندازی کل زیرساخت تنها با یک دستور انجام می‌شود و نیازی به نصب و پیکربندی دستی PostgreSQL یا Redis روی سیستم عامل نیست.
-   **مستندسازی زنده:** این فایل خود یک مستند دقیق از نیازمندی‌های پروژه است.

---

## سرویس‌های تعریف‌شده در `docker-compose.yml`

این فایل، قلب تپنده مدیریت زیرساخت ماست. در حال حاضر، این فایل سرویس‌های زیر را تعریف و مدیریت می‌کند:

### ۱. سرویس `postgres-db` (پایگاه داده)

-   **توضیح:** این سرویس، پایگاه داده اصلی پروژه ما یعنی **PostgreSQL** را راه‌اندازی می‌کند. میکروسرویس‌های مختلف می‌توانند دیتابیس‌های خود را در همین نمونه (Instance) ایجاد کنند.
-   **ایمیج داکر:** `postgres:16` - ما از نسخه ۱۶ که یکی از آخرین نسخه‌های پایدار است استفاده می‌کنیم.
-   **پورت:** پورت داخلی کانتینر (`5432`) به پورت `5433` روی ماشین میزبان (کامپیوتر شما) نگاشت (Map) شده است.
    -   **چرا `5433`؟** برای جلوگیری از هرگونه تداخل با PostgreSQL دیگری که ممکن است به صورت محلی روی سیستم شما نصب و در حال اجرا روی پورت پیش‌فرض `5432` باشد.
-   **ذخیره‌سازی داده‌ها:** داده‌های این سرویس با استفاده از یک **Docker Volume** به نام `postgres_data` به صورت دائمی ذخیره می‌شوند. این یعنی با خاموش و روشن کردن کانتینر، اطلاعات شما از بین نمی‌رود. اگر کانتینر را حذف و دوباره بسازید، به همان داده‌های قبلی متصل خواهد شد.
-   **اطلاعات اتصال اولیه (برای اتصال از میکروسرویس‌ها یا ابزارهای مدیریت دیتابیس):**
    -   **Host:** `postgres-db` (وقتی از داخل یک کانتینر دیگر به آن وصل می‌شویم) یا `localhost` (وقتی از روی سیستم خودمان وصل می‌شویم).
    -   **Port:** `5433` (برای اتصال از سیستم خودمان).
    -   **نام کاربری:** `admin`
    -   **رمز عبور:** `secret`
    -   **نام دیتابیس:** `PersonalGrowthDb`

### ۲. سرویس `redis-cache` (سرور کش)

-   **توضیح:** این سرویس، **Redis** را برای مدیریت کش (Cache) و کارهای پس‌زمینه (در آینده، مثلاً به عنوان یک Message Broker ساده) راه‌اندازی می‌کند.
-   **ایمیج داکر:** `redis:latest`
-   **پورت:** پورت `6379` به صورت مستقیم از کانتینر به سیستم میزبان نگاشت شده است.
-   **ذخیره‌سازی داده‌ها:** داده‌های Redis نیز در یک Docker Volume به نام `redis_data` ذخیره می‌شوند تا در صورت ریستارت شدن کانتینر، داده‌های کش از بین نروند (البته ماهیت کش معمولاً غیردائمی است).

---

## راهنمای عملی

### راه‌اندازی اولیه

برای راه‌اندازی تمام این زیرساخت‌ها برای اولین بار، کافی است در ترمینال خود به این پوشه (`docker`) بیایید و دستور زیر را اجرا کنید:

```shell
docker-compose up -d```

-   **چه اتفاقی می‌افتد؟** `docker-compose` فایل `docker-compose.yml` را می‌خواند، ایمیج‌های مورد نیاز را از اینترنت دانلود می‌کند (فقط بار اول)، کانتینرها را می‌سازد و آن‌ها را در پس‌زمینه اجرا می‌کند.
-   آپشن `-d` یا `--detach` باعث می‌شود که کانتینرها در پس‌زمینه اجرا شوند و ترمینال شما برای اجرای دستورات دیگر آزاد بماند.

### دستورات پرکاربرد روزانه

-   **مشاهده وضعیت کانتینرها:** (ببینید آیا در حال اجرا هستند یا متوقف شده‌اند)
    ```shell
    docker-compose ps
    ```
-   **مشاهده لاگ‌های (گزارش‌های) زنده یک سرویس:** (بسیار مفید برای خطایابی)
    ```shell
    # مثال برای دیدن لاگ‌های دیتابیس
    docker-compose logs -f postgres-db
    ```
    (برای خروج از حالت نمایش لاگ، `Ctrl + C` را بزنید)

-   **متوقف کردن تمام سرویس‌ها:** (کانتینرها متوقف می‌شوند ولی حذف نمی‌شوند)
    ```shell
    docker-compose stop
    ```
-   **شروع مجدد سرویس‌های متوقف شده:**
    ```shell
    docker-compose start
    ```
-   **متوقف کردن و حذف کامل کانتینرها:** (برای زمانی که می‌خواهید همه چیز را از نو بسازید)
    ```shell
    docker-compose down
    ```
-   **حذف کامل به همراه داده‌ها (Volume ها):**
    > **احتیاط!** این دستور تمام داده‌های ذخیره شده در دیتابیس و ردیس را برای همیشه پاک می‌کند. فقط زمانی استفاده کنید که مطمئن هستید به داده‌ها نیازی ندارید.
    ```shell
    docker-compose down -v
    ```

---

## فرآیند راه‌اندازی کاملاً خودکار

هدف اصلی این ساختار، ارائه یک تجربه "یک دستوری" برای توسعه‌دهندگان است.

**چه اتفاقی بعد از `docker-compose up` می‌افتد؟**

1.  **ساخت ایمیج‌ها:** `docker-compose` ابتدا `Dockerfile` مربوط به هر میکروسرویس را پیدا کرده و ایمیج آن را می‌سازد (Build). این فرآیند به لطف کش داکر، در اجراهای بعدی بسیار سریع خواهد بود.

2.  **راه‌اندازی زیرساخت:** کانتینرهای `postgres-db` و `redis-cache` راه‌اندازی می‌شوند.

3.  **راه‌اندازی میکروسرویس‌ها:** کانتینر `identity-service` (و سایر سرویس‌ها در آینده) راه‌اندازی می‌شود.

4.  **اعمال خودکار Migration:** میکروسرویس `identity-service` در لحظه Startup، به دیتابیس متصل شده و به صورت **خودکار** بررسی می‌کند که آیا Migration جدیدی برای اعمال وجود دارد یا خیر. اگر وجود داشته باشد، آن را اجرا می‌کند.

این یعنی شما هرگز نیازی به اجرای دستی دستورات `dotnet ef` برای به‌روزرسانی دیتابیس ندارید.

---

## معماری Full-Stack

پلتفرم شامل سرویس‌های زیر است:

### میکروسرویس‌ها

1. **frontend-web** (Next.js)
   - پورت: `3000`
   - رابط کاربری وب
   - Hot Reload فعال در محیط توسعه (با `docker-compose.override.yml`)

2. **identity-service** (ASP.NET Core)
   - پورت داخلی: `8080`
   - سرویس احراز هویت و مدیریت کاربران
   - پشتیبانی از REST API و gRPC برای ارتباطات داخلی

3. **api-gateway** (YARP)
   - پورت: `8000`
   - نقطه ورود واحد برای تمام درخواست‌های API

4. **loki** (Log Aggregation)
   - پورت: `3100`
   - جمع‌آوری و ذخیره لاگ‌های تمام سرویس‌ها

5. **grafana** (Observability Dashboard)
   - پورت: `3001`
   - داشبورد برای مشاهده و تحلیل لاگ‌ها

### نحوه دسترسی

- **Frontend:** `http://localhost:3000`
- **API Gateway:** `http://localhost:8000`
- **Identity API:** `http://localhost:8000/identity-api/...`
- **Grafana Dashboard:** `http://localhost:3001` (username: `admin`, password: `admin`)

**نکته:** تمام درخواست‌های API باید از طریق Gateway ارسال شوند. Gateway درخواست‌های `/identity-api/...` را به `identity-service` هدایت می‌کند.

### ویژگی‌های پیشرفته

#### Hot Reload برای Frontend
در محیط توسعه، با استفاده از `docker-compose.override.yml`، تغییرات در فایل‌های Frontend به صورت خودکار در مرورگر اعمال می‌شوند. این فایل به صورت خودکار توسط Docker Compose خوانده می‌شود.

#### لاگ متمرکز با Grafana
- به `http://localhost:3001` بروید
- با `admin/admin` وارد شوید
- به بخش "Explore" بروید
- برای مشاهده لاگ‌های یک سرویس خاص، از LogQL استفاده کنید:
  - لاگ‌های `identity-service`: `{container_name="personalgrowth_identity_service"}`
  - لاگ‌های `frontend-web`: `{container_name="personalgrowth_frontend"}`

#### gRPC برای ارتباطات داخلی
`identity-service` علاوه بر REST API، از gRPC نیز پشتیبانی می‌کند. این برای ارتباطات سرویس-به-سرویس بهینه‌تر است.

---

*این مستند با اضافه شدن میکروسرویس‌ها و سایر ابزارهای زیرساختی (مانند RabbitMQ, Loki, و...) به فایل `docker-compose.yml` به‌روزرسانی خواهد شد.*
