# ุณุฑูุณ ุจฺฉุงูพ ุฏุงุฎู MasirYar

ุงู ูุณุชูุฏุงุช ุจู ุชุดุฑุญ ุณุฑูุณ ุจฺฉุงูพ ุฏุงุฎู ุจุฑุง ูพูุชูุฑู MasirYar ูโูพุฑุฏุงุฒุฏ. ุงู ุณุฑูุณ ุจู ุตูุฑุช ฺฉ ฺฉุงูุชูุฑ ุฏุงฺฉุฑ ุงุฌุฑุง ุดุฏู ู ุจู ุทูุฑ ููุธู ุงุฒ ุฏุงุฏูโูุง ุญุงุช ุณุณุชู (PostgreSQL, Redis, ู ูุงูโูุง) ุจฺฉุงูพ ุชูู ูโฺฉูุฏ.

## ๐ ูุงุฒููุฏโูุง

- Docker ู Docker Compose
- ุฏุณุชุฑุณ ุจู ฺฉ ุฑุฌุณุชุฑ ุฏุงฺฉุฑ (ุจุฑุง build ู push ุงูุฌ)
- ุงุจุฒุงุฑูุง `make` (ุงุฎุชุงุฑุ ุจุฑุง ุณูููุช ุฏุฑ ุงุฌุฑุง ุฏุณุชูุฑุงุช)

## โ๏ธ ูพฺฉุฑุจูุฏ

ุชูุงู ูพฺฉุฑุจูุฏโูุง ุงุฒ ุทุฑู ูุชุบุฑูุง ูุญุท ุงูุฌุงู ูโุดูุฏ. ฺฉ ูุงู ููููู ุจู ูุงู `.env.backup.template` ุฏุฑ ููู ูพูุดู ูุฑุงุฑ ุฏุงุฑุฏ. ุจุฑุง ุงุฌุฑุง ุณุฑูุณุ ฺฉ ฺฉูพ ุงุฒ ุงู ูุงู ุจุง ูุงู `.env` ุงุฌุงุฏ ฺฉุฑุฏู ู ููุงุฏุฑ ุขู ุฑุง ูุทุงุจู ุจุง ูุญุท ุฎูุฏ ุชูุธู ฺฉูุฏ.

| ูุชุบุฑ              | ุชูุถุญุงุช                                                                 | ููุฏุงุฑ ูพุดโูุฑุถ      |
| ------------------- | ------------------------------------------------------------------------ | ------------------ |
| `PG_HOST`           | ุขุฏุฑุณ ุณุฑูุณ PostgreSQL.                                                   | `postgres-db`      |
| `PG_USER`           | ูุงู ฺฉุงุฑุจุฑ ุจุฑุง ุงุชุตุงู ุจู ุฏุชุงุจุณ.                                        | `backup_user`      |
| `PG_PASSWORD`       | ุฑูุฒ ุนุจูุฑ ฺฉุงุฑุจุฑ ุฏุชุงุจุณ.                                                  | -                  |
| `REDIS_HOST`        | ุขุฏุฑุณ ุณุฑูุณ Redis.                                                       | `redis`            |
| `FILE_PATHS`        | ูุณุช ุงุฒ ูุณุฑูุง ูุทูู ูุงูโูุง ุจุฑุง ุจฺฉุงูพุ ุฌุฏุง ุดุฏู ุจุง ฺฉุงูุง.                | -                  |
| `BACKUP_DIR`        | ูุณุฑ ุฏุงุฎู ฺฉุงูุชูุฑ ฺฉู ุจฺฉุงูพโูุง ุฏุฑ ุขู ุฐุฎุฑู ูโุดููุฏ.                         | `/backups`         |
| `RETENTION_DAYS`    | ุชุนุฏุงุฏ ุฑูุฒูุง ฺฉู ุจฺฉุงูพโูุง ุจุงุฏ ูฺฏูุฏุงุฑ ุดููุฏ.                             | `7`                |
| `CRON_SCHEDULE`     | ุฒูุงูโุจูุฏ ุงุฌุฑุง ุจฺฉุงูพ ุฏุฑ ูุฑูุช Cron.                                       | `0 2 * * *` (2 ุจุงูุฏุงุฏ) |
| `ADVISORY_LOCK_KEY` | ฺฉ ฺฉูุฏ ุนุฏุฏ ููุญุตุฑ ุจู ูุฑุฏ ุจุฑุง ููู ุฏุฑ PostgreSQL.                        | `123456789`        |

## ๐ ูุญูู ุงุฌุฑุง

### ุงุฌุฑุง ูุณุชูู ุจุฑุง ุชุณุช

ฺฉ ูุงู `docker-compose.backup.yml` ุจุฑุง ุงุฌุฑุง ุณุฑูุณ ุจู ุตูุฑุช ุงุฒููู ู ุจุฑุง ุชุณุช ูุฑุงูู ุดุฏู ุงุณุช.

```bash
# Build ฺฉุฑุฏู ู ุงุฌุฑุง ุณุฑูุณ ุจฺฉุงูพ ุจู ุตูุฑุช ฺฉุจุงุฑู
docker-compose -f docker-compose.backup.yml run --build backup-service run-once

# ุจุฑุง ูุดุงูุฏู ุจฺฉุงูพโูุง ุงุฌุงุฏ ุดุฏู
docker-compose -f docker-compose.backup.yml exec backup-service ls /backups
```

### ุงุฏุบุงู ุจุง `docker-compose` ุงุตู

ุจุฑุง ุงุฏุบุงู ุจุง ูพุฑูฺู ุงุตูุ ูุทุนู ฺฉุฏ ุฒุฑ ุฑุง ุจู ูุงู `docker-compose.yml` ุงุตู ุฎูุฏ ุงุถุงูู ฺฉูุฏ ู ููุงุฏุฑ ุฑุง ูุทุงุจู ุจุง ูุงุฒ ุฎูุฏ ุชูุธู ููุงุฏ.

```yaml
services:
  backup:
    build:
      context: ./ops/backup
    container_name: masiryar-backup
    environment:
      - PG_HOST=postgres-db
      - PG_USER=your_backup_user
      - PG_PASSWORD=${YOUR_DB_PASSWORD}
      - REDIS_HOST=redis
      - FILE_PATHS=/path/to/your/files
      - BACKUP_DIR=/backups
      - RETENTION_DAYS=7
      - CRON_SCHEDULE=0 2 * * *
    volumes:
      - masiryar_backup_data:/backups # Volume ุจุฑุง ูฺฏูุฏุงุฑ ุฏุงุฆู ุจฺฉุงูพโูุง
    restart: on-failure
```

## ๐งช ุชุณุช

Unit testูุง ุจุง ุงุณุชูุงุฏู ุงุฒ `pytest` ููุดุชู ุดุฏูโุงูุฏ.

```bash
# ูุตุจ ูุงุจุณุชฺฏโูุง
pip install -r ops/backup/requirements.txt

# ุงุฌุฑุง ุชุณุชโูุง
pytest ops/backup/tests/
```

## โช ุจุงุฒุงุจ ุจฺฉุงูพ (Restore)

ฺฉ ุงุณฺฉุฑูพุช ฺฉูฺฉ ุจู ูุงู `restore.sh` ุจุฑุง ุจุงุฒุงุจ ุจฺฉุงูพโูุง PostgreSQL ูุฑุงูู ุดุฏู ุงุณุช.

**ูุญูู ุงุณุชูุงุฏู:**

```bash
# ุฏุงุฏู ุฏุณุชุฑุณ ุงุฌุฑุง ุจู ุงุณฺฉุฑูพุช
chmod +x ops/backup/restore.sh

# ุงุฌุฑุง ุงุณฺฉุฑูพุช
PGPASSWORD=your_db_pass ./ops/backup/restore.sh <path_to_backup_dir> <original_db_name> [new_db_name]
```

- `<path_to_backup_dir>`: ูุณุฑ ูพูุดูโุง ฺฉู ุจฺฉุงูพ ุฏุฑ ุขู ูุฑุงุฑ ุฏุงุฑุฏ (ูุซูุงู `/var/lib/docker/volumes/masiryar_backup_data/_data/20231103T102030Z`).
- `<original_db_name>`: ูุงู ุฏุชุงุจุณ ฺฉู ุงุฒ ุขู ุจฺฉุงูพ ฺฏุฑูุชู ุดุฏู ุงุณุช.
- `[new_db_name]` (ุงุฎุชุงุฑ): ูุงู ุฏุชุงุจุณ ุฌุฏุฏ ฺฉู ูโุฎูุงูุฏ ุจฺฉุงูพ ุฏุฑ ุขู ุจุงุฒุงุจ ุดูุฏ.

ุงู ุงุณฺฉุฑูพุช ุจู ุตูุฑุช ุชุนุงูู ุจุฑุง ุญุฐู ุฏุชุงุจุณ ููุตุฏ (ุฏุฑ ุตูุฑุช ูุฌูุฏ) ุงุฒ ุดูุง ุชุงุฏ ุฎูุงูุฏ ฺฏุฑูุช.
